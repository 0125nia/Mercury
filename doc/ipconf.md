ip config

用于调度客户端连接哪个 im 服务器的 http 服务
提供一个 endpoint 信息的列表接口, 对外仅暴露查询接口
内部包含服务发现、配置中心以及缓存服务等来进行对 im 服务器的负载均衡

需要注意的: 
- 负载均衡算法: 当前客户端连接的服务器ip是否是最佳的, 能否达到负载均衡的目的
- 服务器故障时: 服务器故障时会有大量连接该服务器的客户端断开, 此时进行重连操作会导致在ip config中有大量的查询操作, 使得ip config的QPS突增, ip config需要有处理该情况的能力
- 稳定性: 若ip config服务不可用, 客户端拿不到服务器的ip, 自然就无法进行通信, 故ip config的稳定性是十分重要的
- 安全性: 需要有一定的认证流程, 防止滥用保证安全

对此的思考:
对于长连接的负载均衡 传统的负载均衡算法例如轮询、哈希、随机等反式并不适用与以下环境: 
长连接任务的持续时间长, 长期占用服务器资源
任务资源消耗不平均, 不同任务占用不同资源, 导致各个服务器实例的资源消耗有差异, 而不仅仅是依据每个实例上任务的数量
负载信息延迟, 由于网络波动或其它的原因, 可能导致服务端与 ip config 之间的通信存在延迟, 信息不统一导致负载均衡的调度不准确
那对于以上的问题, 我通过查询资料, 了解到另外适用于长连接负载均衡的算法
1. 加权平均法:  记录节点过去几秒的负载数据, 计算对应的加权平均值, 权重根据时间远近的分配, 接近当前时间的负载值权重越高
2. 积分法: 仅记录上一秒的负载情况, 与当前的负载一起计算, 减少数据维护成本, 提高准确性
以节点的剩余资源量作为衡量标准, 选择剩余资源最多的节点分配新的任务, 并通过计算*方差*来评估集群的负载均衡状态, 方差越小就表示负载越均衡

保证ip config 的稳定性关键在于评估负载均衡的监控状态, 当出现不健康的情况时能及时报警或自动降级, 当计算状态许久未更新时也需要有一定的策略来应对
另外的, 选择etcd作为ip config服务的底层依赖, etcd是基于raft算法开发的分布式kv架构, 本身就较为可靠

其它方面其实ip config本身就已经有足够的能力处理, 暂不考虑多余的措施

关于技术选型
Ip config 作为一个http服务, 在此采用hertz框架作为web框架
使用etcd作为服务发现, viper作为配置解析

具体实现

首先主要的代码逻辑比较简单: 
1. 初始化 这个部分分为初始化配置、初始化数据源以及初始化调度层
2. 启动web服务 只有一个用于处理 `/ip/list` 路径的 GET 请求的路由

配置模块使用了viper 固定代码就不赘述了
数据源模块即source 建立与etcd即服务发现中心的连接 负责通过事件驱动监听etcd中某个前缀键值的增删改情况 将事件放入channel中以便后续的操作 
调度层即ipconf的核心区域 遍历事件channel 处理对应事件 更新分发器中的节点数据 使用一系列算法来处理及返回结果
web服务使用hertz框架提供一个Get方法返回调度后的ip列表